<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script defer src="neural-network.js"></script>
    <style>
        body {
            display: flex;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
        }

        button,
        div {
            z-index: 0;
            color: white;
            background-color: black;
            height: fit-content;
        }

        a {
            all: unset;
            z-index: 0;
            color: white;
            background-color: black;
            height: fit-content;
        }

        canvas {
            background-color: black;
            position: absolute;
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>

<body>
    <canvas id="myCanvas"></canvas>
    <a href="paint.html">Test the AI</a>
    <script>
        let arr
        let biases
        async function getData() {
            let n = await fetch('nodes.txt')
            let b = await fetch('biases.txt')
            arr = await n.json()
            biases = await b.json()
        }

        function componentToHex(c) {
            var hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }

        function rgbToHex(r, g, b) {
            return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
        }

        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");
        canvas.width = document.body.scrollWidth
        canvas.height = document.body.scrollHeight

        window.addEventListener('resize', resizeCanvas, false);

        function resizeCanvas() {
            canvas.width = window.innerWidth
            canvas.height = window.innerHeight
            drawNetwork()
        }

        function drawLine(begin, end) {
            ctx.beginPath()
            ctx.moveTo(...begin)
            ctx.lineTo(...end)
            ctx.stroke()
        }

        function drawDot(y, x, size) {
            ctx.beginPath()
            ctx.arc(x, y, size, 0, 2 * Math.PI)
            ctx.stroke()
        }

        function highlightNode(row, column){
            ctx.clearRect(0, 0, canvas.width, canvas.height)
            drawNetwork()

            drawHighlight(row, column)
        }

        canvas.addEventListener("mousemove", (e) => {
            let temp = Math.round(canvas.height / (arr.length + 1))
            let a = e.clientY%temp
            let o = (e.clientY - a) / temp

            let t = 0

            if(o>0){
                t = arr[o-1].length
            }else{
                t = arr[0][0].length
            }
            
            let tt = Math.round(canvas.width / t)
            let aa = e.clientX%tt
            let oo = (e.clientX - aa) / tt

            highlightNode(o, oo)
        })

        function drawHighlight(row, column){
            console.time("Highlight")
            // console.log(row, column)
            let temp = canvas.height / (arr.length + 1)
            let pos = temp / 2 + row*temp

            let len = row==0 ? arr[0][0].length : arr[row-1].length
            let t = canvas.width / len
            let p = t / 2 + column*t
            
            ctx.strokeStyle = rgbToHex(128, 255, 128)
            ctx.lineWidth = 0.0005 * t * temp * (row>0 ? Math.abs(biases[row-1][column]) : 1) + 0.6
            drawDot(pos, p, 0.001 * t * temp)

            if(row<arr.length){
                let bot = arr[row].length
                let te = canvas.width / bot
                let po = te / 2
                for(let i = 0; i<bot; i++){
                    ctx.lineWidth = 0.1 * te * (NeuralNetwork.activation(arr[row][i][column]) + 0.1)
                    drawLine([p, pos], [po, pos+temp])
                    po += te
                }
            }

            if(row<1){
                console.timeEnd("Highlight")
                return
            }
            let a = row > 1 ? arr[row-2] : arr[0][0]
            let top = a.length
            let tem = canvas.width / top
            let posi = tem / 2
            for(let i = 0; i<top; i++){
                try{
                ctx.lineWidth = 0.0002 * tem * temp * (row<1 ? NeuralNetwork.activation(a[i][column]) + 1 : 1)
                }catch{}
                drawLine([p, pos], [posi, pos-temp])
                posi += tem
            }

            console.timeEnd("Highlight")
        }

        function drawNetwork(ar = null, bi = null) {
            arr = ar != null ? ar : arr
            biases = bi != null ? bi : biases
            console.time("draw")
            let c = Math.floor(255 / (arr.length))
            let temp = canvas.height / (arr.length + 1)
            let input = arr[0][0].length
            let t = canvas.width / input
            let pos = temp / 2
            let col = 0

            let co = rgbToHex(col, 0, (255 - col))
            ctx.lineWidth = 0.0002 * t * temp
            ctx.strokeStyle = co
            let p = t / 2

            for (let ind = 0; ind < input; ind++) {
                drawDot(pos, p, 0.001 * t * temp)
                p += t
            }
            pos += temp

            arr.forEach((x, i) => {
                t = canvas.width / x.length
                col += c
                co = rgbToHex(col, 0, (255 - col))
                p = t / 2
                x.forEach((y, ind) => {
                    ctx.strokeStyle = co
                    ctx.lineWidth = 0.0005 * t * temp * Math.abs(biases[i][ind]) + 0.6
                    drawDot(pos, p, 0.001 * t * temp)

                    if (i > 0) {
                        input = arr[i - 1].length
                    }

                    let te = canvas.width / input

                    let po = te / 2

                    for (let index = 0; index < input; index++) {
                        let n = y[index]
                        n = NeuralNetwork.activation(n) + 0.05
                        let grad= ctx.createLinearGradient(...[p, pos], ...[po, pos - temp])
                        grad.addColorStop(0, co)
                        let collo = rgbToHex((col-c), 0, (255 - col + c))
                        grad.addColorStop(1, collo)

                        ctx.strokeStyle = grad

                        ctx.lineWidth = 0.05 * te * n
                        if (n != 0) {
                            drawLine([po, pos - temp], [p, pos])
                        }
                        po += te
                    }

                    p += t
                })
                pos += temp
            })
        console.timeEnd("draw")
        }

        console.time("All")
        console.time("Request")
        getData().then(() => {
            console.timeEnd("Request")
            drawNetwork(arr, biases)
            console.timeEnd("All")
        })


    </script>
</body>

</html>